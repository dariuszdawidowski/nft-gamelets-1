<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <title>Pixelpunk Gamelets NFT Collection #1</title>
        <style type="text/css">

            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            body {
                background-color: #202728;
            }

        </style>
        <script src="jrpg-stellar-engine.js"></script>
    </head>

    <body>
        <div style="display: none;">
            <img id="atlas" src="d490e01c-b2a9-48a8-a2b7-70a6ca2a1806.png">
        </div>
        <script id="tiles" type="text/xml">
            <tileset version="1.10" tiledversion="1.10.2" name="atlas" tilewidth="32" tileheight="32" tilecount="100" columns="10">
                <image source="d490e01c-b2a9-48a8-a2b7-70a6ca2a1806.png" width="320" height="320"/>
            </tileset>
        </script>
        <script id="map" type="text/xml">
            <map version="1.10" tiledversion="1.11.0" orientation="orthogonal" renderorder="right-down" width="10" height="10" tilewidth="32" tileheight="32">
                <tileset firstgid="1" source="tiles"/>
                <layer id="1" name="ground" width="7" height="7" locked="1" offsetx="0" offsety="0">
                    <data encoding="csv">
                        0,0,0,0,0,0,0,
                        0,1,3,3,4,2,0,
                        0,5,15,15,15,6,0,
                        0,5,16,15,15,6,0,
                        0,5,16,15,16,6,0,
                        0,11,13,14,13,12,0,
                        0,0,0,0,0,0,0
                    </data>
                </layer>
                <layer id="2" name="equipment" class="Colliders" width="7" height="7" locked="1" offsetx="0" offsety="0">
                    <data encoding="csv">
                        0,0,0,0,0,0,0,
                        0,0,0,41,52,52,0,
                        0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,
                        0,54,55,0,44,45,0,
                        0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0
                    </data>
                </layer>
                <layer id="3" name="walls" class="Colliders" width="7" height="7" locked="1" offsetx="0" offsety="0">
                    <data encoding="csv">
                        100,100,100,100,100,100,100,
                        100,0,0,0,0,0,100,
                        100,0,0,0,0,0,100,
                        100,0,0,0,0,0,100,
                        100,0,0,0,0,0,100,
                        100,0,0,0,0,0,100,
                        100,100,100,100,100,100,100
                    </data>
                </layer>
                <layer id="4" name="litequipment" width="7" height="7" locked="1" offsetx="0" offsety="0">
                    <data encoding="csv">
                        0,0,0,0,0,0,0,
                        0,0,43,0,0,0,0,
                        0,53,0,0,0,56,0,
                        0,46,0,0,0,51,0,
                        0,0,0,0,0,0,0,
                        0,46,0,0,0,0,0,
                        0,0,0,0,0,0,0
                    </data>
                </layer>
                <objectgroup id="5" name="Objects" locked="1">
                    <object id="1" name="npc:character" type="Spawn" x="96" y="96">
                        <point/>
                    </object>
                </objectgroup>
            </map>
        </script>
        <script id="character" type="text/xml">
            <actor version="0.2" name="bodybuilder" type="MOB" resource="#atlas" width="320" height="320" cols="10" rows="10">
                <movement speed="80"/>
                <collider x="0" y="0" width="22" height="22"/>
                <animation name="idle">
                    <frame tileid="61" duration="100"/>
                </animation>
                <animation name="moveUp">
                    <frame tileid="8" duration="100"/>
                    <frame tileid="9" duration="100"/>
                    <frame tileid="10" duration="100"/>
                </animation>
                <animation name="moveDown">
                    <frame tileid="0" duration="100"/>
                    <frame tileid="1" duration="100"/>
                    <frame tileid="2" duration="100"/>
                </animation>
                <animation name="moveLeft">
                    <frame tileid="12" duration="100"/>
                    <frame tileid="13" duration="100"/>
                    <frame tileid="14" duration="100"/>
                </animation>
                <animation name="moveRight">
                    <frame tileid="4" duration="100"/>
                    <frame tileid="5" duration="100"/>
                    <frame tileid="6" duration="100"/>
                </animation>
            </actor>
        </script>
        <canvas id="main"></canvas>
        <script type="text/javascript">

            class Gamelet {

                constructor() {

                    this.view = new View({ canvas: document.getElementById('main') });
                    this.level = null;
                    this.scale = 4;
                    this.loader = {
                        tsx: new LoaderTSX(),
                        tmx: null,
                        acx: new LoaderACX()
                    };
                    this.lastTime = 0;

                }

                async load() {
                    const tileset = await this.loader.tsx.parseTileSet({ xml: document.getElementById('tiles').innerText, resource: '#atlas', scale: this.scale });
                    this.loader.tmx = new LoaderTMX({'tilesets': {'tiles': tileset}});
                    this.level = await this.loader.tmx.parseLevel({ xml: document.getElementById('map').innerText, scale: this.scale, prefetch: false });
                    this.view.centre({x: 448, y: 448});
                }

                // Start loop
                start() {
                    requestAnimationFrame((currentTime) => {
                        this.lastTime = currentTime;
                        this.mainLoop(currentTime);
                    });
                };

                // Main loop
                mainLoop(currentTime) {
                    // Universal frame time
                    const deltaTime = (currentTime - this.lastTime) / 1000;
                    // Update/Render level
                    this.level.update(this.view, deltaTime);
                    this.level.render(this.view);
                    this.level.debug(this.view);
                    // Time udpate
                    this.lastTime = currentTime;
                    // Next frame synchro
                    requestAnimationFrame(this.mainLoop.bind(this));
                }

            }


            // Init
            window.addEventListener('load', () => {
                const gamelet = new Gamelet();
                gamelet.load().then(() => gamelet.start());
            });
        </script>
    </body>

</html>
